{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///Users/philipp/code/shotexpress-spur-0/webserver/app/page.tsx"],"sourcesContent":["\"use client\";\n\nimport { useEffect, useMemo, useRef, useState } from \"react\";\nimport { connect, IClientOptions, MqttClient } from \"mqtt\";\n\ntype Status = {\n  v: number; seq: number; ts_ms: number;\n  ack_id?: string;\n  motor: { speed: number; direction: \"forward\"|\"reverse\"; state: \"running\"|\"stopped\"|\"error\" };\n  battery_pct?: number;\n  last_tag?: { id: string; ts_ms: number; rssi?: number };\n  error?: string | null;\n};\n\nconst trainId = process.env.NEXT_PUBLIC_TRAIN_ID!;\nconst base = `shotexpress/${trainId}`;\n\nexport default function Page() {\n  const [connected, setConnected] = useState(false);\n  const [presence, setPresence] = useState<string>(\"offline\");\n  const [status, setStatus] = useState<Status | null>(null);\n  const [speed, setSpeed] = useState(0.6);\n  const [direction, setDirection] = useState<\"forward\"|\"reverse\">(\"forward\");\n  const [target, setTarget] = useState(\"raucherecke\");\n  const [stopOn, setStopOn] = useState(\"tag_06\");\n  const clientRef = useRef<MqttClient | null>(null);\n\n  const opts: IClientOptions = useMemo(() => ({\n    clean: true,\n    keepalive: 30,\n    reconnectPeriod: 2000,\n    username: process.env.NEXT_PUBLIC_MQTT_USER,\n    password: process.env.NEXT_PUBLIC_MQTT_PASS,\n    protocolVersion: 4\n  }), []);\n\n  useEffect(() => {\n    const url = process.env.NEXT_PUBLIC_MQTT_URL!;\n    const c = connect(url, opts);\n    clientRef.current = c;\n\n    c.on(\"connect\", () => setConnected(true));\n    c.on(\"reconnect\", () => setConnected(false));\n    c.on(\"close\", () => setConnected(false));\n    c.on(\"error\", () => setConnected(false));\n\n    c.subscribe(`${base}/presence`, { qos: 1 });\n    c.subscribe(`${base}/status`, { qos: 0 });\n\n    c.on(\"message\", (topic, payload) => {\n      if (topic.endsWith(\"/presence\")) setPresence(payload.toString());\n      if (topic.endsWith(\"/status\")) {\n        try { setStatus(JSON.parse(payload.toString())); } catch {}\n      }\n    });\n\n    return () => { c.end(true); };\n  }, [opts]);\n\n  function publishCmd(cmd: any) {\n    const c = clientRef.current;\n    if (!c || !connected) return;\n    c.publish(`${base}/cmd`, JSON.stringify(cmd), { qos: 1 });\n  }\n\n  function sendMove() {\n    const now = Date.now();\n    const cmd = {\n      v: 1,\n      id: `cmd_${now}`,\n      seq: now,    // simple unique monotonic for demo\n      ts_ms: now,\n      type: \"move_to\",\n      params: {\n        target,\n        speed,\n        direction,\n        expected_tags: [\"tag_03\", \"tag_04\", \"tag_05\"],\n        stop_on_tag: stopOn,\n        offline_plan: {\n          approach_slowdown_ms: 2000,\n          max_run_ms_without_tag: 7000,\n          crawl_speed: 0.15,\n          dwell_ms: 1500\n        },\n        ttl_ms: 15000\n      }\n    };\n    publishCmd(cmd);\n  }\n\n  function sendStop() {\n    const now = Date.now();\n    publishCmd({\n      v: 1, id: `cmd_${now}`, seq: now, ts_ms: now,\n      type: \"stop\", params: {}\n    });\n  }\n\n  return (\n    <main style={{ maxWidth: 720, margin: \"2rem auto\", fontFamily: \"system-ui, sans-serif\" }}>\n      <h1>ShotExpress</h1>\n      <p>Broker: {connected ? \"connected\" : \"disconnected\"} Â· Train: {presence}</p>\n\n      <section style={{ padding: \"1rem\", border: \"1px solid #ddd\", borderRadius: 8, marginTop: 12 }}>\n        <h2>Move to</h2>\n        <label>Target&nbsp;\n          <input value={target} onChange={e => setTarget(e.target.value)} />\n        </label>\n        <br />\n        <label>Stop on tag&nbsp;\n          <input value={stopOn} onChange={e => setStopOn(e.target.value)} />\n        </label>\n        <br />\n        <label>Direction&nbsp;\n          <select value={direction} onChange={e => setDirection(e.target.value as any)}>\n            <option value=\"forward\">forward</option>\n            <option value=\"reverse\">reverse</option>\n          </select>\n        </label>\n        <br />\n        <label>Speed {speed.toFixed(2)}\n          <input type=\"range\" min=\"0\" max=\"1\" step=\"0.01\"\n                 value={speed}\n                 onChange={e => setSpeed(parseFloat(e.target.value))} />\n        </label>\n        <br />\n        <button onClick={sendMove} disabled={!connected}>Send move_to</button>\n        <button onClick={sendStop} style={{ marginLeft: 8 }} disabled={!connected}>Stop</button>\n      </section>\n\n      <section style={{ padding: \"1rem\", border: \"1px solid #ddd\", borderRadius: 8, marginTop: 12 }}>\n        <h2>Status</h2>\n        {!status ? <p>No status yet.</p> :\n          <pre style={{ whiteSpace: \"pre-wrap\" }}>{JSON.stringify(status, null, 2)}</pre>}\n      </section>\n    </main>\n  );\n}\n"],"names":[],"mappings":"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","debugId":null}}]
}